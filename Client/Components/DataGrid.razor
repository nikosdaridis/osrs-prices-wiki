@implements IDisposable

@inject PeriodicExecutorFactory PeriodicExecutorFactory
@inject ClientService ClientService
@inject IOptions<OsrsWikiValues> OptionsOsrsWiki
@inject NavigationManager NavigationManager

@if (_periodicExecutor is not null)
{
    <UpdateProgressCircle LastExecution="_periodicExecutor.LastExecution" />
}

<RadzenDataGrid @ref=_grid Count=@_items.Count() Data=@_items PageSize=25 PagerAlwaysVisible=true AllowColumnReorder=true AllowFiltering=true
                FilterPopupRenderMode=PopupRenderMode.OnDemand AllowColumnResize=true FilterMode=FilterMode.Advanced AllowPaging=true AllowSorting=true
                ColumnWidth="100px" LogicalFilterOperator=LogicalFilterOperator.And PagerPosition=PagerPosition.TopAndBottom
                PagerHorizontalAlign=HorizontalAlign.Center FilterCaseSensitivity=FilterCaseSensitivity.CaseInsensitive AllowColumnPicking=true
                PageSizeOptions=_pageSizeOptions PageSizeText="">
    <Columns>
        <CustomDataGridColumn Property=Id Title=Id Width="30px" MinWidth="40px" Visible=false
                              CssClass="cursor-pointer"
                              FilterOperator=FilterOperator.Equals SecondFilterOperator=FilterOperator.GreaterThan>
            <Template Context=item>
                <RadzenText Text=@item.Id.ToString() onclick=@(() => NavigateToItem(item)) />
            </Template>
        </CustomDataGridColumn>
        <RadzenDataGridColumn Property=Icon Title=Icon Filterable=false Sortable=false Width="30px" MinWidth="40px"
                              CssClass="cursor-pointer">
            <Template Context=item>
                <RadzenImage Path=@item.Icon onclick=@(() => NavigateToItem(item)) />
            </Template>
        </RadzenDataGridColumn>
        <CustomDataGridColumn Property=Name Title=Name Width="100px" MinWidth="60px"
                              CssClass="cursor-pointer">
            <Template Context=item>
                <RadzenText Text=@item.Name onclick=@(() => NavigateToItem(item)) />
            </Template>
        </CustomDataGridColumn>
        <CustomDataGridColumn Property=Examine Title=Examine Width="100px" MinWidth="60px" Visible=false />
        <CustomDataGridColumn Property=InstaBuy Title="Insta Buy" Width="70px" MinWidth="70px"
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Text=@item.InstaBuy.ToString("N0") />
            </Template>
        </CustomDataGridColumn>
        <CustomDataGridColumn Property=InstaSell Title="Insta Sell" Width="70px" MinWidth="70px"
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Text=@item.InstaSell.ToString("N0") />
            </Template>
        </CustomDataGridColumn>
        <CustomDataGridColumn Property=Margin Title=Margin Width="50px" MinWidth="50px"
                              SortOrder=SortOrder.Descending
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Style=@($"color: {CSSHelper.GetColor(nameof(item.Margin), item.Margin)}") Text="@NumericUtility.FormatNumber(item.Margin)" />
            </Template>
        </CustomDataGridColumn>
        <CustomDataGridColumn Property=RoiPercentage Title=Roi Width="50px" MinWidth="50px"
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Style=@($"color: {CSSHelper.GetColor(nameof(item.RoiPercentage), item.RoiPercentage)}")
                            Text=@($"{item.RoiPercentage:F1}%") />
            </Template>
        </CustomDataGridColumn>
        <CustomDataGridColumn Property=MarginXVolume Title="Margin x Volume" Width="60px" MinWidth="60px"
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Style=@($"color: {CSSHelper.GetColor(nameof(item.MarginXVolume), item.MarginXVolume)}")
                            Text=@NumericUtility.FormatNumber(item.MarginXVolume) />
            </Template>
        </CustomDataGridColumn>
        <CustomDataGridColumn Property=Volume Title=Volume Width="50px" MinWidth="50px"
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Style=@($"color: {CSSHelper.GetColor(nameof(item.Volume), item.Volume)}")
                            Text=@NumericUtility.FormatNumber(item.Volume) />
            </Template>
        </CustomDataGridColumn>
        <CustomDataGridColumn Property=Limit Title=Limit Width="50px" MinWidth="50px" Visible=false
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Text=@NumericUtility.FormatNumber(item.Limit, "0") />
            </Template>
        </CustomDataGridColumn>
        <RadzenDataGridColumn FilterValue=_instaBuyTimeFilterValue Property=InstaBuyTime Title="Latest Insta Buy" Width="70px" MinWidth="70px"
                              FilterOperator=@(_instaBuyTimeFilterDirection == TimeDirection.Before ? FilterOperator.LessThanOrEquals : FilterOperator.GreaterThanOrEquals)>
            <Template Context=item>
                <RadzenText Style=@($"color: {CSSHelper.GetColor(nameof(item.InstaBuyTime), item.InstaBuyTime)}")
                            Text=@($"{NumericUtility.FormatSeconds(item.InstaBuyTime)} ago") />
            </Template>
            <FilterTemplate>
                <CustomTimeFilterTemplate @bind-FilterValue=_instaBuyTimeFilterValue @bind-TimeDirection=_instaBuyTimeFilterDirection
                                          @bind-TimeNumber=_instaBuyTimeFilterNumber @bind-TimeUnit=_instaBuyTimeFilterUnit />
            </FilterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn FilterValue=_instaSellTimeFilterValue Property=InstaSellTime Title="Latest Insta Sell" Width="70px" MinWidth="70px"
                              FilterOperator=@(_instaSellTimeFilterDirection == TimeDirection.Before ? FilterOperator.LessThanOrEquals : FilterOperator.GreaterThanOrEquals)>
            <Template Context=item>
                <RadzenText Style=@($"color: {CSSHelper.GetColor(nameof(item.InstaSellTime), item.InstaSellTime)}")
                            Text=@($"{NumericUtility.FormatSeconds(item.InstaSellTime)} ago") />
            </Template>
            <FilterTemplate>
                <CustomTimeFilterTemplate @bind-FilterValue=_instaSellTimeFilterValue @bind-TimeDirection=_instaSellTimeFilterDirection
                                          @bind-TimeNumber=_instaSellTimeFilterNumber @bind-TimeUnit=_instaSellTimeFilterUnit />
            </FilterTemplate>
        </RadzenDataGridColumn>
        <CustomDataGridColumn Property=Value Title=Value Width="50px" MinWidth="50px" Visible=false
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Text=@NumericUtility.FormatNumber(item.Value, "0") />
            </Template>
        </CustomDataGridColumn>
        <CustomDataGridColumn Property=HighAlch Title=HighAlch Width="60px" MinWidth="60px" Visible=false
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Text=@NumericUtility.FormatNumber(item.HighAlch, "0") />
            </Template>
        </CustomDataGridColumn>
        <CustomDataGridColumn Property=LowAlch Title=LowAlch Width="60px" MinWidth="60px" Visible=false
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Text=@NumericUtility.FormatNumber(item.LowAlch, "0") />
            </Template>
        </CustomDataGridColumn>
        <RadzenDataGridColumn Property=Accessibility Title=Members Width="40px" MinWidth="40px" Visible=false
                              LogicalFilterOperator=LogicalFilterOperator.Or>
            <Template Context=item>
                <RadzenImage Path=@StringUtility.BuildUri(OptionsOsrsWiki.Value.OldschoolWikiIconsBaseUri,
                             $"{(item.Accessibility == Accessibility.Members ? "Member_icon" : "Free-to-play_icon")}.png", '_') />
            </Template>
        </RadzenDataGridColumn>
        <CustomDataGridColumn Property=Tax Title=Tax Width="50px" MinWidth="50px" Visible=false
                              FilterOperator=FilterOperator.GreaterThanOrEquals SecondFilterOperator=FilterOperator.LessThanOrEquals>
            <Template Context=item>
                <RadzenText Text=@NumericUtility.FormatNumber(item.Tax) />
            </Template>
        </CustomDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    private PeriodicExecutor? _periodicExecutor;
    private readonly IEnumerable<int> _pageSizeOptions = new int[] { 10, 15, 25, 50, 100 };
    private RadzenDataGrid<ItemModel> _grid = new();
    private IEnumerable<ItemModel> _items = [];

    private long? _instaBuyTimeFilterValue = (int)TimeUnit.Hours;
    private TimeDirection _instaBuyTimeFilterDirection = TimeDirection.Before;
    private long? _instaBuyTimeFilterNumber = 1;
    private TimeUnit _instaBuyTimeFilterUnit = TimeUnit.Hours;

    private long? _instaSellTimeFilterValue = (int)TimeUnit.Hours;
    private TimeDirection _instaSellTimeFilterDirection = TimeDirection.Before;
    private long? _instaSellTimeFilterNumber = 1;
    private TimeUnit _instaSellTimeFilterUnit = TimeUnit.Hours;

    protected override void OnInitialized()
    {
        _items = ClientService.GetCachedItems();
        _periodicExecutor = PeriodicExecutorFactory.Create(60_000);
        _periodicExecutor.JobExecuted += HandleJobExecuted;
        _periodicExecutor.StartExecuting();
    }

    private void HandleJobExecuted(object? sender, JobExecutedEventArgs e)
    {
        InvokeAsync(async () =>
           {
               int pageBeforeReload = _grid.CurrentPage;
               _items = await ClientService.GetLatestItems();
               StateHasChanged();
               await _grid.GoToPage(pageBeforeReload, true);
           });
    }

    private void NavigateToItem(ItemModel item) => NavigationManager.NavigateTo($"/{StringUtility.BuildUri(item.Id.ToString(), item.Name, '-')}");

    public void Dispose()
    {
        if (_periodicExecutor is null)
            return;

        _periodicExecutor.JobExecuted -= HandleJobExecuted;
        _periodicExecutor.Dispose();
    }
}
