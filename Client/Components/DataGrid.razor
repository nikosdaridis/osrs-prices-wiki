@implements IDisposable

@inject PeriodicExecutorFactory PeriodicExecutorFactory
@inject ClientService ClientService
@inject IOptions<OsrsWikiValues> OptionsOsrsWiki
@inject NavigationManager NavigationManager

@if (_periodicExecutor is not null)
{
    <UpdateProgressCircle LastExecution="_periodicExecutor.LastExecution" />
}

<RadzenDataGrid @ref="_grid" Count="@_items.Count()" Data="@_items" PageSize="15" PagerAlwaysVisible="true" AllowColumnReorder="true" AllowFiltering="true"
                FilterPopupRenderMode="PopupRenderMode.OnDemand" AllowColumnResize="true" FilterMode="FilterMode.Advanced" AllowPaging="true" AllowSorting="true"
                ColumnWidth="100px" LogicalFilterOperator="LogicalFilterOperator.And" PagerPosition="PagerPosition.TopAndBottom"
                PagerHorizontalAlign="HorizontalAlign.Center" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowColumnPicking="true"
                PageSizeOptions="_pageSizeOptions" PageSizeText="">
    <Columns>
        <RadzenDataGridColumn Property="Id" Title="Id" CssClass="cursor-pointer" Visible="false" Width="30px" MinWidth="40px">
            <Template Context="item">
                <RadzenText Text="@item.Id.ToString()" onclick="@(() => NavigateToItem(item))" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Icon" Title="Icon" CssClass="cursor-pointer" Filterable="false" Sortable="false" Width="30px" MinWidth="40px">
            <Template Context="item">
                <RadzenImage Path="@item.Icon" onclick="@(() => NavigateToItem(item))" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Name" Title="Name" CssClass="cursor-pointer" Width="100px" MinWidth="60px">
            <Template Context="item">
                <RadzenText Text="@item.Name" onclick="@(() => NavigateToItem(item))" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Examine" Title="Examine" Visible="false" Width="100px" MinWidth="60px" />
        <RadzenDataGridColumn Property="InstaBuy" Title="Insta Buy" Width="70px" MinWidth="70px">
            <Template Context="item">
                <RadzenText Text="@item.InstaBuy.ToString("N0")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="InstaSell" Title="Insta Sell" Width="70px" MinWidth="70px">
            <Template Context="item">
                <RadzenText Text="@item.InstaSell.ToString("N0")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Margin" Title="Margin" SortOrder="SortOrder.Descending" Width="50px" MinWidth="50px">
            <Template Context="item">
                <RadzenText Style="@($"color: {CSSUtility.GetColor(nameof(item.Margin), item.Margin)}")" Text="@NumericUtility.FormatNumber(item.Margin)" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="RoiPercentage" Title="Roi" Width="50px" MinWidth="50px">
            <Template Context="item">
                <RadzenText Text="@($"{item.RoiPercentage:F1}%")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="MarginXVolume" Title="Margin x Volume" Width="60px" MinWidth="60px">
            <Template Context="item">
                <RadzenText Text="@NumericUtility.FormatNumber(item.MarginXVolume)" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Volume" Title="Volume" Width="50px" MinWidth="50px">
            <Template Context="item">
                <RadzenText Text="@NumericUtility.FormatNumber(item.Volume)" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Limit" Title="Limit" Visible="false" Width="50px" MinWidth="50px">
            <Template Context="item">
                <RadzenText Text="@NumericUtility.FormatNumber(item.Limit, "0")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="InstaBuyTime" Title="Latest Insta Buy" FilterOperator="FilterOperator.LessThan" FilterValue="@_defaultInstaTimeFilter" Width="70px" MinWidth="70px">
            <Template Context="item">
                <RadzenText Text="@($"{NumericUtility.FormatSeconds(item.InstaBuyTime)} ago")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="InstaSellTime" Title="Latest Insta Sell" FilterOperator="FilterOperator.LessThan" FilterValue="@_defaultInstaTimeFilter" Width="70px" MinWidth="70px">
            <Template Context="item">
                <RadzenText Text="@($"{NumericUtility.FormatSeconds(item.InstaSellTime)} ago")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Value" Title="Value" Visible="false" CssClass="text-green-500" Width="50px" MinWidth="50px">
            <Template Context="item">
                <RadzenText Text="@NumericUtility.FormatNumber(item.Value, "0")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="HighAlch" Title="HighAlch" Visible="false" Width="60px" MinWidth="60px">
            <Template Context="item">
                <RadzenText Text="@NumericUtility.FormatNumber(item.HighAlch, "0")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="LowAlch" Title="LowAlch" Visible="false" Width="60px" MinWidth="60px">
            <Template Context="item">
                <RadzenText Text="@NumericUtility.FormatNumber(item.LowAlch, "0")" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Members" Title="Members" Visible="false" Width="40px" MinWidth="40px">
            <Template Context="item">
                <RadzenImage Path="@StringUtility.BuildUri(OptionsOsrsWiki.Value.OldschoolWikiIconsBaseUri, $"{(item.Members ? "Member_icon" : "Free-to-play_icon")}.png", '_')" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="Tax" Title="Tax" Visible="false" Width="50px" MinWidth="50px">
            <Template Context="item">
                <RadzenText Text="@NumericUtility.FormatNumber(item.Tax)" />
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    private PeriodicExecutor? _periodicExecutor;
    private readonly IEnumerable<int> _pageSizeOptions = new int[] { 10, 15, 25, 50, 100 };
    private RadzenDataGrid<ItemModel>? _grid;
    private IEnumerable<ItemModel> _items = [];

    private long _defaultInstaTimeFilter = 3600;

    protected override void OnInitialized()
    {
        _items = ClientService.GetCachedItems();
        _periodicExecutor = PeriodicExecutorFactory.Create(60_000);
        _periodicExecutor.JobExecuted += HandleJobExecuted;
        _periodicExecutor.StartExecuting();
    }

    private void HandleJobExecuted(object? sender, JobExecutedEventArgs e)
    {
        InvokeAsync(async () =>
       {
           _items = await ClientService.GetLatestItems();
           _grid?.Reload();
           StateHasChanged();
       });
    }

    private void NavigateToItem(ItemModel item) => NavigationManager.NavigateTo($"/{StringUtility.BuildUri(item.Id.ToString(), item.Name, '-')}");

    public void Dispose()
    {
        if (_periodicExecutor is null)
            return;

        _periodicExecutor.JobExecuted -= HandleJobExecuted;
        _periodicExecutor.Dispose();
    }
}
